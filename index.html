<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="title">Ultimate Connect Hub ⚡</title>
    <meta name="theme-color" content="#4f46e5">

    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="manifest" href="manifest.json">

    <style>
    /* ---------------------- */
    /* GLOBAL STYLE */
    /* ---------------------- */
    :root {
        --bg: #f5f7fa;
        --card: #ffffff;
        --text: #2c3e50;
        --primary: #4f46e5;
        --primary-light: #6d64ec;
        --secondary: #10b981;
        --border: #e6e8eb;
        --shadow-light: 0 15px 40px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 18px 45px rgba(0, 0, 0, 0.15);
    }

    body.dark {
        --bg: #1e2125;
        --card: #282c34;
        --text: #e0e6f0;
        --primary-light: #9a94ec;
        --border: #3a3f45;
        --shadow-light: 0 15px 40px rgba(0, 0, 0, 0.3);
        --shadow-hover: 0 18px 45px rgba(0, 0, 0, 0.5);
    }

    body.lite {
        transition: none;
        --shadow-light: none;
        --shadow-hover: none;
    }
    body.lite .card { box-shadow: none !important; transform: none !important; }
    body.lite .btn, body.lite .grid button { transition: none !important; transform: none !important; }

    body {
        font-family: 'Vazirmatn', sans-serif;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        transition: background 0.5s, color 0.5s;
        line-height: 1.7;
        font-size: 15px;
        overflow-x: hidden;
    }

    [lang="en"] body {
        font-family: 'Roboto', sans-serif;
        direction: ltr;
    }
    [lang="fa"] body {
        direction: rtl;
    }

    /* ---------------------- */
    /* LAYOUT - موبایل (پیش‌فرض)          */
    /* ---------------------- */
    .container {
        max-width: 1200px;
        margin: auto;
        padding: 15px 10px;
    }
    h1 {
        text-align: center;
        font-size: 28px;
        margin: 10px 0 5px;
        color: var(--primary);
        font-weight: 700;
        letter-spacing: 0.5px;
    }
    h3 {
        margin-top: 0;
        font-size: 18px;
        padding-bottom: 5px;
        margin-bottom: 15px;
        color: var(--text);
        border-bottom: 3px solid var(--primary);
        width: fit-content;
    }

    /* طرح‌بندی اصلی: یک ستونه در موبایل */
    .main-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-top: 15px;
    }
    .left-column, .right-column, .full-width {
         grid-column: 1 / 2;
    }

    .card {
        background: var(--card);
        border: 1px solid var(--border);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 15px;
        box-shadow: var(--shadow-light);
        transition: box-shadow 0.4s, background 0.4s, transform 0.3s;
    }
    .card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-hover);
    }
    body.lite .card:hover { transform: none; }

    /* ---------------------- */
    /* QUICK TEST FIX (Optimized for Mobile) */
    /* ---------------------- */
    .quick-test-group {
        display: flex;
        flex-direction: column; /* عمودی در موبایل */
        gap: 8px;
        margin-bottom: 8px;
    }
    .quick-test-group button {
        width: 100% !important;
        flex: none !important;
        margin: 0;
    }
    .btn-auto-width {
        flex: 0 1 auto !important;
        width: 100% !important;
    }

    /* ---------------------- */
    /* BUTTONS         */
    /* ---------------------- */
    .btn {
        width: 100%;
        background: var(--primary);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        margin: 6px 0;
        font-size: 15px;
        font-weight: 700;
        transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
        box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .btn i { margin-left: 6px; }
    [lang="en"] .btn i { margin-right: 6px; margin-left: 0; }
    .btn:hover:not(:disabled) {
        background: var(--primary-light);
        transform: translateY(-1px);
    }
    .btn:active {
        transform: translateY(0);
        box-shadow: 0 3px 10px rgba(79, 70, 229, 0.4);
    }
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
    }
    .btn-outline {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        box-shadow: none;
    }
    .btn-outline:hover:not(:disabled) {
        background: var(--border);
    }
    .btn-sm {
        padding: 8px 15px;
        font-size: 13px;
        width: auto;
        border-radius: 8px;
        box-shadow: none;
    }


    /* ---------------------- */
    /* LINK GRID */
    /* ---------------------- */
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
    }
    .grid button {
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        cursor: pointer;
        transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);

        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
    }
    .grid button i {
        margin-bottom: 6px;
        font-size: 20px;
        transition: transform 0.3s;
    }
    .grid button:hover {
        background: var(--bg);
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    /* ---------------------- */
    /* WIDGETS (نتایج زنده) */
    /* ---------------------- */
    .result {
        background: rgba(79,70,229,0.1);
        color: var(--primary);
        padding: 15px;
        border-radius: 14px;
        display: none;
        margin-top: 20px;
        font-size: 15px;
        font-weight: 700;
        border: 1px dashed var(--primary);
        white-space: pre-line;
    }
    .speed-widget {
        display: flex;
        justify-content: space-around;
        text-align: center;
        margin-top: 15px;
    }
    .speed-item {
        padding: 10px;
        border-radius: 12px;
        min-width: 80px;
        background: var(--bg);
        border: 1px solid var(--border);
        transition: background 0.3s;
    }
    .speed-label {
        font-size: 12px;
        opacity: 0.7;
    }
    .speed-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--secondary);
    }

    /* ---------------------- */
    /* INPUTS */
    /* ---------------------- */
    input {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
        transition: border-color 0.3s;
        box-sizing: border-box;
        font-family: inherit;
        font-size: 14px;
    }
    input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* ---------------------- */
    /* SETTINGS ROW */
    /* ---------------------- */
    .settings-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
    }
    .settings-row span {
        font-size: 14px;
        font-weight: 700;
    }
    /* ---------------------- */
    /* TOP CREATOR BANNER */
    /* ---------------------- */
    .top-creator-banner {
        text-align: center;
        font-size: 14px;
        margin-bottom: 20px;
        padding: 8px 10px;
        border-radius: 10px;
        background: var(--primary);
        color: white;
        font-weight: 700;
        box-shadow: 0 5px 20px rgba(79, 70, 229, 0.3);
    }
    .top-creator-banner a {
        color: var(--secondary);
        text-decoration: none;
        font-weight: 700;
        margin: 0 5px;
        transition: color 0.3s;
    }

    /* ---------------------- */
    /* DESKTOP MEDIA QUERY */
    /* ---------------------- */
    @media (min-width: 769px) {
        .container {
            padding: 30px 20px;
        }
        h1 {
            font-size: 36px;
            margin: 15px 0 10px;
        }
        h3 {
            font-size: 20px;
            margin-bottom: 20px;
        }
        .main-layout {
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-top: 20px;
        }
        .left-column { grid-column: 1 / 2; }
        .right-column { grid-column: 2 / 3; }
        .full-width { grid-column: 1 / 3; }
        .card { padding: 25px; border-radius: 20px; margin-bottom: 20px; }
        .card:hover { transform: translateY(-5px); }

        .btn {
            padding: 15px;
            border-radius: 12px;
            margin: 8px 0;
            font-size: 16px;
        }
        .btn i { margin-left: 8px; }
        [lang="en"] .btn i { margin-right: 8px; margin-left: 0; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }

        .grid {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        .grid button { padding: 15px; border-radius: 15px; font-size: 15px; }
        .grid button i { margin-bottom: 8px; font-size: 24px; }

        .speed-item { padding: 15px; min-width: 100px; }
        .speed-label { font-size: 13px; }
        .speed-value { font-size: 24px; }

        input { padding: 12px; border-radius: 10px; font-size: 16px; }
        .settings-row span { font-size: 16px; }

        /* Quick Test Group: Horizontal on Desktop */
        .quick-test-group {
            flex-direction: row;
            gap: 10px;
            margin-bottom: 10px;
        }
        .quick-test-group button {
            flex: 1 !important;
            width: auto !important;
        }
    }
    </style>
</head>

<body lang="fa">
<div class="container">

    <h1 data-key="title">Ultimate Connect Hub ⚡</h1>

    <div class="top-creator-banner">
        <span data-key="creator_text">طراحی و توسعه توسط</span>
        <span style="color: white; font-weight: 700;">xsparvin</span>
        <i class="fab fa-telegram-plane"></i>
        <a href="https://t.me/xsfsociety" target="_blank" data-key="telegram_channel">کانال تلگرامی xsfsociety</a>
    </div>

    <div class="main-layout">

        <div class="left-column">
            
            <div class="card full-width-mobile">
                <h3 data-key="general_shortcuts_title">میانبرهای عمومی</h3>
                <div class="grid">
                    <button onclick="openLink('https://web.whatsapp.com')"><i class="fab fa-whatsapp" style="color:#25D366;"></i><span data-key="sh_whatsapp">واتساپ</span></button>
                    <button onclick="openLink('https://web.telegram.org')"><i class="fab fa-telegram-plane" style="color:#0088CC;"></i><span data-key="sh_telegram">تلگرام</span></button>
                    <button onclick="openLink('https://instagram.com')"><i class="fab fa-instagram" style="color:#E1306C;"></i><span data-key="sh_instagram">اینستاگرام</span></button>
                    <button onclick="openLink('https://speedtest.net')"><i class="fas fa-tachometer-alt" style="color:var(--primary);"></i><span data-key="sh_speedtest">اسپیدتست</span></button>
                </div>
            </div>

            <div class="card full-width-mobile">
                <h3 data-key="quick_test_title">تست اتصال سریع</h3>

                <div class="quick-test-group">
                     <button class="btn" id="btn-ping" onclick="pingGoogle()"><i class="fas fa-satellite-dish"></i> <span data-key="btn_ping">پینگ گوگل</span></button>
                     <button class="btn btn-outline btn-auto-width" id="btn-multitest" onclick="multiCheck()"><i class="fas fa-check-double"></i> <span data-key="btn_multitest">تست چند سرور</span></button>
                </div>

                <div class="quick-test-group">
                    <button class="btn btn-outline" id="btn-dns" onclick="checkDNS()"><i class="fas fa-server"></i> <span data-key="btn_dns">بررسی DNS</span></button>
                    <button class="btn btn-outline" id="btn-https" onclick="checkHTTPS()"><i class="fas fa-lock"></i> <span data-key="btn_https">بررسی HTTPS</span></button>
                </div>

                <div id="result" class="result"></div>
            </div>

            <div class="card full-width-mobile">
                <h3 data-key="graph_title">نمودار پینگ زنده (شبیه‌سازی)</h3>
                <div id="pingGraphContainer" style="height: 250px; margin-bottom: 15px;">
                    <canvas id="pingChart"></canvas>
                </div>
                <button class="btn-sm btn-outline" id="startGraphBtn" onclick="startPingGraph()"><i class="fas fa-chart-line"></i> <span data-key="btn_start_graph">شروع نمودار</span></button>
            </div>

            <div class="card full-width-mobile">
                <h3 data-key="speed_test_title">تست سرعت دقیق‌تر</h3>
                <button class="btn" id="btn-speedtest" onclick="startAdvancedSpeedTest()"><i class="fas fa-bolt"></i> <span data-key="btn_start_speed">شروع تست</span></button>
                <div class="speed-widget">
                    <div class="speed-item">
                        <div class="speed-label" data-key="label_download">دانلود</div>
                        <div class="speed-value" id="downloadSpeed">0.00</div>
                        <div class="speed-label">Mbps</div>
                    </div>
                    <div class="speed-item">
                        <div class="speed-label" data-key="label_upload">آپلود</div>
                        <div class="speed-value" id="uploadSpeed">0.00</div>
                        <div class="speed-label">Mbps</div>
                    </div>
                    <div class="speed-item">
                        <div class="speed-label" data-key="label_latency">پینگ</div>
                        <div class="speed-value" id="pingSpeed">0</div>
                        <div class="speed-label">ms</div>
                    </div>
                </div>
                <div id="speedResult" class="result" style="margin-top: 15px;"></div>
            </div>
            
            <div class="card full-width-mobile">
                <h3 data-key="layout_status_title">وضعیت نما</h3>
                <div class="settings-row">
                    <span data-key="current_layout">نما فعلی</span>
                    <span id="layoutStatus" style="font-size: 16px; font-weight: 700; color: var(--secondary);">دسکتاپ</span>
                </div>
            </div>

        </div>

        <div class="right-column">

            <div class="card">
                <h3 data-key="my_shortcuts_title">میانبرهای من</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <input id="customName" type="text" data-key="ph_name" placeholder="نام" style="flex: 1;">
                    <input id="customURL" type="url" data-key="ph_link" placeholder="لینک (با https://)" style="flex: 1;" value="https://">
                </div>
                <button class="btn-sm btn" onclick="addShortcut()"><i class="fas fa-plus"></i> <span data-key="btn_add_shortcut">افزودن میانبر</span></button>

                <div id="myLinks" style="margin-top: 15px;"></div>
            </div>

            <div class="card">
                <h3 data-key="settings_title">تنظیمات ظاهر</h3>
                <div class="settings-row">
                    <span data-key="setting_theme">تم شب/روز</span>
                    <button class="btn-sm btn-outline" onclick="toggleDarkMode()"><i class="fas fa-adjust"></i> <span data-key="btn_toggle">تغییر</span></button>
                </div>
                <div class="settings-row">
                    <span data-key="setting_lite">حالت سبک (Lite)</span>
                    <button class="btn-sm btn-outline" id="liteToggle" onclick="toggleLite()"><i class="fas fa-low-vision"></i> <span data-key="btn_toggle">تغییر</span></button>
                </div>
                <div class="settings-row">
                    <span data-key="setting_lang">تغییر زبان</span>
                    <button class="btn-sm btn-outline" onclick="toggleLanguage()"><i class="fas fa-language"></i> <span id="langToggleText">English</span></button>
                </div>
            </div>

        </div>

    </div>

</div>

<script>
let pingChartInstance = null;
let pingInterval = null;
let maxDataPoints = 30;
let pingDelay = 1500;
// زبان پیش‌فرض
let language = localStorage.getItem("lang") || "fa";

// -----------------------------------
// TEXT TRANSLATIONS (ترجمه‌ها)
// -----------------------------------
const translations = {
    "fa": {
        "title": "Ultimate Connect Hub ⚡",
        "quick_test_title": "تست اتصال سریع",
        "btn_ping": "پینگ گوگل",
        "btn_multitest": "تست چند سرور",
        "btn_dns": "بررسی DNS",
        "btn_https": "بررسی HTTPS",
        "graph_title": "نمودار پینگ زنده (شبیه‌سازی)",
        "btn_start_graph": "شروع نمودار",
        "speed_test_title": "تست سرعت دقیق‌تر",
        "btn_start_speed": "شروع تست",
        "label_download": "دانلود",
        "label_upload": "آپلود",
        "label_latency": "پینگ",
        "general_shortcuts_title": "میانبرهای عمومی",
        "sh_whatsapp": "واتساپ",
        "sh_telegram": "تلگرام",
        "sh_instagram": "اینستاگرام",
        "sh_speedtest": "اسپیدتست",
        "my_shortcuts_title": "میانبرهای من",
        "ph_name": "نام",
        "ph_link": "لینک (با https://)",
        "btn_add_shortcut": "افزودن میانبر",
        "layout_status_title": "وضعیت نما",
        "current_layout": "نما فعلی",
        "layout_desktop": "دسکتاپ",
        "layout_mobile": "موبایل",
        "settings_title": "تنظیمات ظاهر",
        "setting_theme": "تم شب/روز",
        "setting_lite": "حالت سبک (Lite)",
        "setting_lang": "تغییر زبان",
        "btn_toggle": "تغییر",
        "creator_text": "طراحی و توسعه توسط",
        "telegram_channel": "کانال تلگرامی xsfsociety",
        "res_testing_ping": "در حال تست پینگ...",
        "res_ping": (duration) => `پینگ (Latency): <b>${duration}ms</b>`,
        "res_timeout": "ارتباط با گوگل برقرار نشد (Timeout یا خطا) ✖",
        "res_dns_ok": "DNS سالم است ✔ (IP 1.1.1.1 پاسخ داد)",
        "res_dns_fail": "DNS پاسخ نمی‌دهد یا Timeout رخ داد ✖",
        "res_https_ok": "HTTPS سالم ✔ (گواهی معتبر)",
        "res_https_fail": "HTTPS در دسترس نیست یا گواهی مشکل دارد ✖",
        "res_multitest_start": "نتایج:<br>",
        "res_multitest_ok": (s) => `✔ <b>${s}</b> فعال</b><br>`,
        "res_multitest_fail": (s) => `✖ <b>${s}</b> قطع<br>`,
        "speed_testing": "در حال انجام تست سرعت (دانلود و آپلود)...",
        "speed_fail": "تست سرعت شکست خورد ✖ (خطا یا CORS)",
        "alert_shortcut": "لطفاً نام و لینک را وارد کنید.",
        "stop_graph": "توقف نمودار",
        "start_graph": "شروع نمودار",
        "speed_result": (d, u) => `تست کامل شد. دانلود: <b>${d} Mbps</b> | آپلود: <b>${u} Mbps</b>`,
    },
    "en": {
        "title": "Ultimate Connect Hub ⚡",
        "quick_test_title": "Quick Connection Test",
        "btn_ping": "Ping Google",
        "btn_multitest": "Multi Server Test",
        "btn_dns": "Check DNS",
        "btn_https": "Check HTTPS",
        "graph_title": "Live Ping Graph (Simulated)",
        "btn_start_graph": "Start Graph",
        "speed_test_title": "Advanced Speed Test",
        "btn_start_speed": "Start Test",
        "label_download": "Download",
        "label_upload": "Upload",
        "label_latency": "Latency",
        "general_shortcuts_title": "General Shortcuts",
        "sh_whatsapp": "WhatsApp",
        "sh_telegram": "Telegram",
        "sh_instagram": "Instagram",
        "sh_speedtest": "Speedtest",
        "my_shortcuts_title": "My Shortcuts",
        "ph_name": "Name",
        "ph_link": "Link (with https://)",
        "btn_add_shortcut": "Add Shortcut",
        "layout_status_title": "Layout Status",
        "current_layout": "Current Layout",
        "layout_desktop": "Desktop",
        "layout_mobile": "Mobile",
        "settings_title": "Appearance Settings",
        "setting_theme": "Dark/Light Mode",
        "setting_lite": "Lite Mode",
        "setting_lang": "Change Language",
        "btn_toggle": "Toggle",
        "creator_text": "Designed and Developed by",
        "telegram_channel": "Telegram Channel xsfsociety",
        "res_testing_ping": "Testing Ping...",
        "res_ping": (duration) => `Latency: <b>${duration}ms</b>`,
        "res_timeout": "Connection to Google failed (Timeout or Error) ✖",
        "res_dns_ok": "DNS is healthy ✔ (IP 1.1.1.1 responded)",
        "res_dns_fail": "DNS failed to respond or Timeout occurred ✖",
        "res_https_ok": "HTTPS is healthy ✔ (Valid Certificate)",
        "res_https_fail": "HTTPS is unavailable or Certificate error ✖",
        "res_multitest_start": "Results:<br>",
        "res_multitest_ok": (s) => `✔ <b>${s}</b> Active</b><br>`,
        "res_multitest_fail": (s) => `✖ <b>${s}</b> Down<br>`,
        "speed_testing": "Performing speed test (Download and Upload)...",
        "speed_fail": "Speed test failed ✖ (Error or CORS)",
        "alert_shortcut": "Please enter both name and link.",
        "stop_graph": "Stop Graph",
        "start_graph": "Start Graph",
        "speed_result": (d, u) => `Test complete. Download: <b>${d} Mbps</b> | Upld: <b>${u} Mbps</b>`,
    }
};

// -----------------------------------
// LANGUAGE TOGGLE
// -----------------------------------
function applyLanguage(lang) {
    const texts = translations[lang];
    document.body.setAttribute('lang', lang);
    document.body.style.direction = (lang === 'fa' ? 'rtl' : 'ltr');

    document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.getAttribute('data-key');
        if (texts[key] && typeof texts[key] === 'string') {
            el.textContent = texts[key];
        }
    });

    document.querySelectorAll('[placeholder]').forEach(el => {
        const key = el.getAttribute('data-key');
        if (key && texts[key] && typeof texts[key] === 'string') {
            el.setAttribute('placeholder', texts[key]);
        }
    });

    document.getElementById('langToggleText').textContent = (lang === 'fa' ? 'English' : 'فارسی');
    loadShortcuts();
    checkLayout();
}

function toggleLanguage() {
    language = (language === 'fa' ? 'en' : 'fa');
    localStorage.setItem("lang", language);
    applyLanguage(language);
}

applyLanguage(language);


// -----------------------------------
// LAYOUT CHECK WIDGET
// -----------------------------------
function checkLayout() {
    const statusEl = document.getElementById('layoutStatus');
    const isMobile = window.innerWidth <= 768;

    if (statusEl) {
         if (isMobile) {
            statusEl.textContent = translations[language]["layout_mobile"];
        } else {
            statusEl.textContent = translations[language]["layout_desktop"];
        }
    }
}
window.onload = checkLayout;
window.onresize = checkLayout;

/* ----------------------------------- */
/* DARK MODE                  */
/* ----------------------------------- */
function toggleDarkMode(){
    document.body.classList.toggle("dark");
    localStorage.setItem("dark", document.body.classList.contains("dark"));
    if (pingChartInstance) {
        updateChartColors();
    }
}
if(localStorage.getItem("dark") === "true"){
    document.body.classList.add("dark");
}

function updateChartColors() {
    const isDark = document.body.classList.contains('dark');
    const color = isDark ? '#9a94ec' : '#4f46e5';
    const gridColor = isDark ? '#3a3f45' : '#e6e8eb';
    const textColor = isDark ? '#e0e6f0' : '#2c3e50';

    if (pingChartInstance) {
        pingChartInstance.data.datasets[0].borderColor = color;
        pingChartInstance.options.scales.y.grid.color = gridColor;
        pingChartInstance.options.scales.x.grid.color = gridColor;
        pingChartInstance.options.scales.y.ticks.color = textColor;
        pingChartInstance.options.scales.x.ticks.color = textColor;
        pingChartInstance.options.scales.y.title.color = textColor;
        pingChartInstance.update();
    }
}

/* ----------------------------------- */
/* QUICK TOOLS               */
/* ----------------------------------- */
function showResult(msg, elementId = "result"){
    const r = document.getElementById(elementId);
    r.style.display = "block";
    r.innerHTML = msg;
}

function openLink(url){
    window.open(url, "_blank");
}

async function simulatePing(url){
    const t = performance.now();
    try{
        // استفاده از timeout برای جلوگیری از بلاک شدن طولانی
        const response = await fetch(url, {
            mode: "no-cors",
            cache: "no-store",
            signal: AbortSignal.timeout(5000)
        });
        const duration = Math.round(performance.now() - t);
        document.getElementById('pingSpeed').textContent = duration;
        return duration;
    }catch(e){
        document.getElementById('pingSpeed').textContent = '—';
        return null;
    }
}

async function pingGoogle(){
    document.getElementById("btn-ping").disabled = true;
    showResult(translations[language]["res_testing_ping"], "result");

    const duration = await simulatePing("https://www.google.com/favicon.ico");

    document.getElementById("btn-ping").disabled = false;

    if(duration !== null){
        showResult(translations[language]["res_ping"](duration), "result");
    }else{
        showResult(translations[language]["res_timeout"], "result");
    }
}

async function checkDNS(){
    document.getElementById("btn-dns").disabled = true;
    try{
        // Cloudflare DNS check
        const r = await fetch("https://1.1.1.1", {mode:"no-cors", signal: AbortSignal.timeout(3000)});
        showResult(translations[language]["res_dns_ok"]);
    }catch(e){
        showResult(translations[language]["res_dns_fail"], "result");
    }
    document.getElementById("btn-dns").disabled = false;
}

async function checkHTTPS(){
    document.getElementById("btn-https").disabled = true;
    try{
        const r = await fetch("https://example.com", {signal: AbortSignal.timeout(3000)});
        if (r.ok) {
             showResult(translations[language]["res_https_ok"]);
        } else {
             // 4xx or 5xx status, but reachable
             showResult(translations[language]["res_https_fail"]);
        }
    }catch(e){
         // Network error or timeout
        showResult(translations[language]["res_https_fail"], "result");
    }
    document.getElementById("btn-https").disabled = false;
}

async function multiCheck(){
    const btn = document.getElementById("btn-multitest");
    if (btn) btn.disabled = true;

    const servers = {
        "Google": "https://www.google.com/favicon.ico",
        "Cloudflare": "https://1.1.1.1",
        "Telegram Web": "https://web.telegram.org/favicon.ico",
        "Example Site": "https://example.com"
    };
    let text = translations[language]["res_multitest_start"];

    // اجرای تست‌ها به صورت سریالی
    for (const [s, url] of Object.entries(servers)){
        try{
            await fetch(url, {mode:"no-cors", signal: AbortSignal.timeout(4000)});
            text += translations[language]["res_multitest_ok"](s);
        }catch(e){
            text += translations[language]["res_multitest_fail"](s);
        }
    }
    showResult(text);
    if (btn) btn.disabled = false;
}


/* ----------------------------------- */
/* PING GRAPH                */
/* ----------------------------------- */
function setupChart() {
    const ctx = document.getElementById('pingChart').getContext('2d');
    pingChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(maxDataPoints).fill(''),
            datasets: [{
                label: 'Latency (ms)',
                data: Array(maxDataPoints).fill(0),
                fill: 'origin',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: 0,
                    max: 500,
                    title: { display: true, text: 'Latency (ms)', color: (document.body.classList.contains('dark') ? '#e0e6f0' : '#2c3e50') }
                },
                x: {
                    display: false
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            },
            animation: false,
            interaction: {
                intersect: false,
            }
        }
    });
    updateChartColors();
}
window.addEventListener('load', setupChart);


function startPingGraph(){
    const btn = document.getElementById('startGraphBtn');
    if (pingInterval) {
        clearInterval(pingInterval);
        pingInterval = null;
        btn.innerHTML = `<i class="fas fa-chart-line"></i> <span data-key="btn_start_graph">${translations[language]["start_graph"]}</span>`;
        return;
    }

    btn.innerHTML = `<i class="fas fa-pause-circle"></i> <span data-key="stop_graph">${translations[language]["stop_graph"]}</span>`;

    pingInterval = setInterval(async ()=>{
        const duration = await simulatePing("https://www.google.com/favicon.ico");

        let pingValue = duration !== null ? duration : 500;

        if (pingValue > 500) pingValue = 500;

        // Add new data and shift old data
        pingChartInstance.data.datasets[0].data.push(pingValue);
        if (pingChartInstance.data.datasets[0].data.length > maxDataPoints) {
            pingChartInstance.data.datasets[0].data.shift();
        }

        pingChartInstance.update('none');
    }, pingDelay);
}


/* ----------------------------------- */
/* ADVANCED SPEED TEST (SIMULATED) */
/* ----------------------------------- */
const TEST_FILE_URL = "https://speed.hetzner.de/10MB.bin"; // 10MB test file
const UPLOAD_SIZE_KB = 100; // Simulated upload size

function updateSpeedWidget(download, upload, ping) {
    document.getElementById('downloadSpeed').textContent = download.toFixed(2);
    document.getElementById('uploadSpeed').textContent = upload.toFixed(2);
    document.getElementById('pingSpeed').textContent = ping;
}

async function testDownload() {
    const start = performance.now();
    let totalReceived = 0;
    try {
        const response = await fetch(TEST_FILE_URL, { signal: AbortSignal.timeout(15000) });
        if (!response.body) throw new Error("No response body");
        const reader = response.body.getReader();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            totalReceived += value.length;
        }

        const duration = (performance.now() - start) / 1000;
        // Convert Bytes/sec to Mbps (Bytes * 8 / 1024 / 1024 / Duration)
        const speedMbps = ((totalReceived * 8) / 1024 / 1024 / duration);
        return speedMbps;
    } catch (e) {
        console.error("Download failed:", e);
        return 0;
    }
}

async function testUpload() {
    // This is a SIMULATED upload test as true cross-origin upload speed requires a server endpoint
    const start = performance.now();
    try {
        // Simulate a fixed delay for the "upload" process
        await new Promise(resolve => setTimeout(resolve, 800)); // 0.8 seconds simulation time

        const duration = (performance.now() - start) / 1000;
        // Calculate speed based on simulated size and time (Kb * 1024 * 8 / 1024 / 1024 / Duration)
        const speedMbps = ((UPLOAD_SIZE_KB * 1024 * 8) / 1024 / 1024 / duration);
        return speedMbps;
    } catch (e) {
        console.error("Upload failed:", e);
        return 0;
    }
}

async function startAdvancedSpeedTest(){
    const btn = document.getElementById("btn-speedtest");
    const box = document.getElementById("speedResult");

    btn.disabled = true;
    showResult(translations[language]["speed_testing"], "speedResult");
    updateSpeedWidget(0, 0, 0);

    // 1. Ping Test
    const pingTime = await simulatePing("https://www.google.com/favicon.ico");
    const ping = pingTime !== null ? pingTime : 0;
    document.getElementById('pingSpeed').textContent = ping;


    // 2. Download Test
    box.innerHTML = translations[language]["speed_testing"] + (language === 'fa' ? " (دانلود...)" : " (Downloading...)");
    const downloadSpeed = await testDownload();
    updateSpeedWidget(downloadSpeed, 0, ping);

    // 3. Upload Test
    box.innerHTML = translations[language]["speed_testing"] + (language === 'fa' ? " (آپلود...)" : " (Uploading...)");
    const uploadSpeed = await testUpload();
    updateSpeedWidget(downloadSpeed, uploadSpeed, ping);

    // 4. Final Result
    if (downloadSpeed > 0 || uploadSpeed > 0 || ping > 0) {
        showResult(translations[language]["speed_result"](downloadSpeed.toFixed(2), uploadSpeed.toFixed(2)), "speedResult");
    } else {
        showResult(translations[language]["speed_fail"], "speedResult");
    }

    btn.disabled = false;
}


/* ----------------------------------- */
/* PERSONAL SHORTCUTS            */
/* ----------------------------------- */
function loadShortcuts(){
    const list = JSON.parse(localStorage.getItem("links") || "[]");
    const myLinksDiv = document.getElementById("myLinks");
    myLinksDiv.innerHTML = "";

    const isRtl = language === 'fa';

    list.forEach(x => {
        const div = document.createElement('div');
        div.style.cssText = 'display:flex; align-items:center; margin-bottom: 8px;';

        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.onclick = () => openLink(x.url);
        btn.style.cssText = 'flex-grow: 1; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
        btn.textContent = x.name;

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn-sm btn-outline';
        removeBtn.style.cssText = `width: 40px; margin-${isRtl ? 'right' : 'left'}: 8px; flex-shrink: 0;`;
        removeBtn.onclick = () => removeShortcut(x.name);
        removeBtn.innerHTML = '<i class="fas fa-trash"></i>';

        // Set order based on RTL/LTR
        if (isRtl) {
            div.appendChild(removeBtn);
            div.appendChild(btn);
        } else {
            div.appendChild(btn);
            div.appendChild(removeBtn);
        }

        myLinksDiv.appendChild(div);
    });
}
loadShortcuts();

function addShortcut(){
    let name = document.getElementById("customName").value.trim();
    let url = document.getElementById("customURL").value.trim();

    if(!name || !url || url === 'https://') {
        alert(translations[language]["alert_shortcut"]);
        return;
    }

    if(!url.startsWith('http')) {
        url = 'https://' + (url.startsWith('//') ? url.substring(2) : url);
    }

    let list = JSON.parse(localStorage.getItem("links") || "[]");
    list.push({name,url});
    localStorage.setItem("links", JSON.stringify(list));

    document.getElementById("customName").value = "";
    document.getElementById("customURL").value = "https://";
    loadShortcuts();
}

function removeShortcut(name) {
    let list = JSON.parse(localStorage.getItem("links") || "[]");
    list = list.filter(x => x.name !== name);
    localStorage.setItem("links", JSON.stringify(list));
    loadShortcuts();
}

/* ----------------------------------- */
/* LITE MODE                */
/* ----------------------------------- */
function toggleLite(){
    document.body.classList.toggle("lite");
    localStorage.setItem("lite", document.body.classList.contains("lite"));
}
if(localStorage.getItem("lite") === "true"){
    document.body.classList.add("lite");
}
</script>
</body>
</html>

